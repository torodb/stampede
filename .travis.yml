language: java
script: mvn -Psafer -Pintegration -Passembler -B -e -T 1C verify
jdk:
  - oraclejdk8
  - oraclejdk7
addons:
  postgresql: "9.4"
  apt:
    packages:
      - oracle-java8-installer
services:
  - docker
  - postgresql

env:
  global:
    - DOCKER_ENGINE_VERSION=1.11.1-0~precise
    - DOCKER_COMPOSE_VERSION=1.7.1
  matrix:
    - Protocol=Mongo Backend=Postgres
    - DOCKER_TEST=TRUE
#    - Protocol=Mongo Backend=MySQL
#    - Protocol=Mongo Backend=Greenplum
#    - Protocol=MongoReplSet Backend=Postgres

matrix:
  exclude:
    - jdk: oraclejdk7
      env: Protocol=Mongo Backend=Greenplum
    - jdk: oraclejdk7
      env: Protocol=Mongo Backend=MySQL
    - jdk: oraclejdk7
      env: Protocol=MongoReplSet Backend=Postgres
    - jdk: oraclejdk7
      env: DOCKER_TEST=TRUE
  allow_failures:
    - env: Protocol=MongoReplSet Backend=Postgres

before_install:
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo /etc/init.d/postgresql stop; fi

install:
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo sh -c 'echo "deb https://apt.dockerproject.org/repo ubuntu-precise main" > /etc/apt/sources.list.d/docker.list'; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo apt-get update; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo apt-key update; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo apt-get -qqy -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install docker-engine=${DOCKER_ENGINE_VERSION}; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then chmod +x docker-compose; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo mv docker-compose /usr/local/bin; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker-compose -v; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker -v; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then sudo apt-get install mongodb-clients -y; fi

before_script:
  - export GIT_BRANCH=$TRAVIS_BRANCH
  - source ./.travis/prepare_backend.sh
  - source ./.travis/prepare_protocol.sh
  - echo $PATH
  - java -version
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker-compose up -d --build; fi

script:
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker ps | grep torodb_postgres_1; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker ps | grep torodb_toro_1; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker ps; fi
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then source .travis/test_connection_to_torodb.sh; fi

after_script:
  -  if [[ "$DOCKER_TEST" == "TRUE" ]]; then docker-compose down; fi

sudo: false

before_deploy:
  - echo "<settings><servers><server><id>ossrh-snapshot</id><username>\${env.MAVEN_DEPLOY_USER}</username><password>\${env.MAVEN_DEPLOY_PASS}</password></server><server><id>ossrh-release</id><username>\${env.MAVEN_DEPLOY_USER}</username><password>\${env.MAVEN_DEPLOY_PASS}</password></server></servers></settings>" > ~/settings.xml
  - export RELEASE_TAR_BZ2_FILE=$(ls torodb/target/dist/torodb-*-release.tar.bz2)
  - export RELEASE_ZIP_FILE=$(ls torodb/target/dist/torodb-*-release.zip)
deploy:
  - provider: releases
    api_key:
      secure: g2kUTryp5anBi6xzkHT4CfTFJz3K1q1nYYwjtNfreCoEGrjTA6A4ZgU/utVTOJxeNWmKZ1QO4suegKfsRCpiSqNvp85lM49qeXAp/xxuI0ac+J7JJALeGEn0AyLmhuHu/BBm3dIG+6oi+cXRsTKAX8uTqrT9P1tkfaUhEEV1XmA4tU3uEqzHiazPUKXysxAOacqeUfvZh+MoZaqA54p0UjmOilTMGnQvpv2uR7tBnXNGVXkqyonH6HsxAOwKdyZAYwsg2hvCNREJUCgl/OVkQI/H8+SmOfZ4btHxZqX3U5iVLZ9CugsUbqflvVzVd7KIPn4DPXalkSDLsJ2SxBio7Y1t50omDIlb7NsClR4JDAzME5XKw8XR9glmC0uDTMxMuhgXYWLq2JgQUlnD8vWh1SGsdUCNa+aQMlcYdIIMQZG50LgY5s+E2YVEzJ7NrWm66UCqeuxjqWetrGin1eFOY0+y2/+Pe4tr2ZhrbGhlqS11GKWy+tKLM9v7+L2w1gjKJaqcmbtVfja1kehaP7JLhq2S2S7jmcTggy4bx5B9U4rVwWq1cv5sXXXNEsvB/PzifXHV3z38O/ed8ddJpCTkhfubAr6zOKkyGdkPvXbdAmDOVWw5JPbP1fWDojaRgqxumf7MUhAlOGxmj//hgpwh/Q8/QVKCJ+lQRq89H5bT0q4=
    skip_cleanup: true
    file:
      - "${RELEASE_TAR_BZ2_FILE}"
      - "${RELEASE_ZIP_FILE}"
    on:
      repo: torodb/torodb
      tags: true
      jdk: oraclejdk8
  - provider: script
    script: mvn -B -e -T 1C -Pdeploy -DskipTests=true deploy --settings ~/settings.xml
    skip_cleanup: true
    on:
      repo: torodb/torodb
      branch: devel
      jdk: oraclejdk8
